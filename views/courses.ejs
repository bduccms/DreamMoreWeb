<section id="courses" class="py-5" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
  <div class="container">
    <h1 class="section-title text-center mb-5" style="color: #ffffff;">Training Courses</h1>

    <% if (error) { %>
      <div class="alert alert-danger text-center"><%= error %></div>
    <% } %>

    <% if (courses && courses.length > 0) { %>
      <% for (let i = 0; i < courses.length; i += 2) { %>
        <div class="row mb-4">
          <% courses.slice(i, i + 2).forEach(course => { %>
            <div class="col-md-6 mb-6 d-flex">
              <div class="card h-100 flex-fill shadow-sm" style="border-radius: 10px; width: 100%; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; background: linear-gradient(to bottom, #ff7800, #16213e);">
                <img src="/Uploads/<%= course.photo || 'default.jpg' %>" alt="<%= course.title %>" class="card-img-top" style="height: 400px; object-fit: cover;">
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title text-white fs-5"><%= course.title %></h5>
                  <h6 class="text-black  fw-bold fs-5"><%= course.price %> ETB</h6>
                  <p class="card-text text-light" style="font-family: 'Times New Roman', Times, serif; font-size: 15px;"><%= course.description || 'Start your journey with our practical and professional training.' %></p>

                  <div class="mt-auto">
                    <%
                      let userApplication = null;
                      if (user && user.applications && Array.isArray(user.applications)) {
                        userApplication = user.applications.find(app => app.course_key.trim() === course.title.trim());
                      }
                    %>

                    <% if (userApplication && userApplication.status === 'approved') { %>
                      <!-- ✅ Show Access button for approved users -->
                      <a href="/courses/<%= encodeURIComponent(course.title) %>" class="btn btn-success w-100 py-2">
                        <i class="fas fa-unlock-alt me-2"></i> Access
                      </a>

                    <% } else if (userApplication && userApplication.status === 'pending') { %>
                      <!-- ⏳ Show Pending button for pending applications -->
                      <button class="btn btn-warning w-100 py-2" disabled>
                        <i class="fas fa-hourglass-half me-2"></i> Pending Approval
                      </button>

                    <% } else { %>
                      <!-- 📝 Show Apply button for new users -->
                      <button id="applybtn" class="btn btn-primary py-2 apply-btn" 
                              data-bs-toggle="modal" 
                              data-bs-target="<%= user ? '#applyModal_' + course.title.replace(/\s+/g, '_') : '#signInModal' %>" 
                              data-course-title="<%= course.title %>"
                              style="min-width: 150px;">
                        <i class="fas fa-paper-plane me-2"></i> Apply Now
                      </button>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>

            <% if (user) { %>
              <!-- Full-Screen Apply Modal -->
              <div class="modal fade" id="applyModal_<%= course.title.replace(/\s+/g, '_') %>" tabindex="-1" aria-labelledby="applyModalLabel_<%= course.title.replace(/\s+/g, '_') %>" aria-hidden="true">
                <div class="modal-dialog modal-fullscreen" role="document">
                  <div class="modal-content" style="background: linear-gradient(to bottom, #1a1a2e, #16213e);">
                    <div class="modal-header text-white p-1" style="background: linear-gradient(to right, #ff7800, #010318);">
                      <h5 class="modal-title" style="font-size: 30px;" id="applyModalLabel_<%= course.title.replace(/\s+/g, '_') %>">
                        <i class="fas fa-graduation-cap me-3"></i>Apply for <%= course.title %>
                      </h5>
                      <button type="button" class="p-3 btn-close" style="background-color: white; color: red;" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <div class="container">

                        <!-- Step 1: Welcome & Confirm Payment -->
                        <section id="applyContent_<%= course.title.replace(/\s+/g, '_') %>" aria-live="polite">
                          <div class="text-center mb-4 text-white">
                            <h4>Welcome to <strong><%= course.title %></strong> Training!</h4>
                            <p class="lead">Join our professional course and unlock your potential.</p>
                            <ul class="list-group list-group-flush mx-auto" style="max-width: 600px; background: rgba(255,255,255,0.1);">
                              <li class="list-group-item text-white" style="background: transparent;">Learn from expert instructors</li>
                              <li class="list-group-item text-white" style="background: transparent;">Lifetime access to course materials</li>
                              <li class="list-group-item text-white" style="background: transparent;">Earn a certification upon completion</li>
                            </ul>
                            <button  type="button"   style="background-color: #ff7800; color: #ffffff;"   class="btn  mt-4 confirm-payment-btn py-3 px-5" 
                                    aria-describedby="paymentInstructions_<%= course.title.replace(/\s+/g, '_') %>" 
                                    data-course-title="<%= course.title.replace(/\s+/g, '_') %>"
                                    style="font-size: 1.2rem;">
                              <i class="fas fa-arrow-right me-2"></i> Confirm Payment
                            </button>
                          </div>
                        </section>

                        <!-- Step 2: Payment Instructions and Upload -->
                        <section id="paymentSteps_<%= course.title.replace(/\s+/g, '_') %>" class="d-none" role="region" aria-live="polite" aria-labelledby="paymentInstructionsLabel_<%= course.title.replace(/\s+/g, '_') %>">
                          <div class="d-flex">
                            <div class="step-icon me-4 mt-5">
                              <span class="badge bg-primary rounded-circle p-3" style="font-size: 1.5rem;">1</span>
                            </div>
                            <div class="border w-50 mx-auto p-3 border-primary border-3 fw-5 fs-5 my-3 text-white">
                              <h5 id="paymentInstructionsLabel_<%= course.title.replace(/\s+/g, '_') %>">
                                <i class="fas fa-money-bill-wave me-2"></i>Payment Instructions
                              </h5>
                              <p>Please send your payment for <strong><%= course.title %></strong> using one of the following methods:</p>
                            </div>
                          </div>
                          
                          <ul class="mb-4 d-flex w-100" style="max-width: 700px; margin-left: 28%;">
                            <li class="list-group-item text-white p-3" style="background-color: #010318; font-size: 20px;">
                              <i class="fas fa-mobile-alt me-2"></i><strong>Telebirr</strong>: 
                              <div class="input-group mt-2">
                                <input type="text" class="form-control bg-dark text-white" value="+251978466718" readonly>
                                <button class="btn btn-outline-light copy-btn" type="button">
                                  <i class="fas fa-copy"></i>
                                </button>
                              </div>
                            </li>
                            <li class="list-group-item p-3" style="background-color: #ff7800; color: white; font-size: 20px;">
                              <i class="fas fa-university me-2"></i><strong>CBE Birr</strong>:
                              <div class="input-group mt-2">
                                <input type="text" class="form-control bg-white" value="1000221667429" readonly>
                                <button class="btn btn-outline-dark copy-btn" type="button">
                                  <i class="fas fa-copy"></i>
                                </button>
                              </div>
                            </li>
                          </ul>

                          <div class="d-flex">
                            <div class="step-icon me-4 mt-5">
                              <span class="badge bg-primary rounded-circle p-3" style="font-size: 1.5rem;">2</span>
                            </div>
                            <div class="border w-50 mx-auto p-3 border-primary border-3 fw-5 fs-5 text-white">
                              <h5>
                                <i class="fas fa-upload me-2"></i>Upload Payment Screenshot
                              </h5>
                              <form id="applyForm_<%= course.title.replace(/\s+/g, '_') %>" action="/courses/apply" method="POST" enctype="multipart/form-data" novalidate>
                                <input type="hidden" name="courseKey" value="<%= course.title %>">
                                <input type="hidden" name="userId" value="<%= user.id %>">
                                <div class="mb-3" style="max-width: 400px;">
                                  <label for="screenshot_<%= course.title.replace(/\s+/g, '_') %>" class="form-label text-white">
                                    Payment Screenshot <span class="text-danger">*</span>
                                  </label>
                                  <input type="file" class="form-control bg-dark text-white" id="screenshot_<%= course.title.replace(/\s+/g, '_') %>" name="screenshot" accept="image/*" required aria-required="true">
                                  <div class="preview-container mt-2 d-none">
                                    <img id="preview_<%= course.title.replace(/\s+/g, '_') %>" src="#" alt="Preview" class="img-thumbnail" style="max-height: 200px;">
                                  </div>
                                </div>
                                <p class="text-warning" style="font-size: 20px; font-family: 'Times New Roman', Times, serif;">
                                  <i class="fas fa-exclamation-circle me-2"></i>Keep your payment proof. Contact support if access isn't granted within 24 hours.
                                </p>
                                <button type="submit" class="btn btn-success submit-btn py-2 px-4">
                                  <i class="fas fa-paper-plane me-2"></i> Submit Application
                                </button>
                              </form>
                            </div>
                          </div>
                          
                          <div id="thankYou_<%= course.title.replace(/\s+/g, '_') %>" class="d-none mt-4 text-center bg-success text-white p-4 rounded" tabindex="0" aria-live="assertive">
                            <h4><i class="fas fa-check-circle me-2"></i>Thank You!</h4>
                            <p style="font-family: 'Times New Roman', Times, serif; font-size: 20px; font-weight: 800;">
                              Your application for <strong><%= course.title %></strong> has been submitted successfully.
                            </p>
                            <p class="text-white" style="font-family: 'Times New Roman', Times, serif; font-size: 20px; font-weight: 800;">
                              We'll review your payment and grant access within 24 hours.
                            </p>
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                              <i class="fas fa-check me-2"></i> Close
                            </button>
                          </div>
                        </section>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <% } %>
          <% }) %>
        </div>
      <% } %>
    <% } else { %>
      <p class="text-center text-muted">No courses available at the moment.</p>
    <% } %>
  </div>
</section>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  /* Card hover effect */
  .card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
  }
  
  /* Modal improvements */
  .modal-content {
    border-radius: 0;
  }
  
  /* Step indicator */
  .step-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
  }
  
  /* File upload preview */
  .preview-container img {
    max-width: 100%;
    height: auto;
  }
  
  /* Copy button animation */
  .copy-btn {
    transition: all 0.3s ease;
  }
  
  .copy-btn:hover {
    transform: scale(1.1);
  }
  
  /* Apply button */
  .apply-btn {
    transition: all 0.3s ease;
  }
  
  .apply-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Original functionality for showing payment steps
  document.querySelectorAll('.confirm-payment-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const courseTitle = btn.dataset.courseTitle;
      const applyContent = document.getElementById(`applyContent_${courseTitle}`);
      const paymentSteps = document.getElementById(`paymentSteps_${courseTitle}`);
      if (applyContent && paymentSteps) {
        applyContent.classList.add('d-none');
        paymentSteps.classList.remove('d-none');
        // Focus on the first input for accessibility
        const firstInput = paymentSteps.querySelector('input');
        if (firstInput) firstInput.focus();
      }
    });
  });

  // File preview functionality
  document.querySelectorAll('input[type="file"]').forEach(input => {
    input.addEventListener('change', function() {
      const previewId = this.id.replace('screenshot_', 'preview_');
      const preview = document.getElementById(previewId);
      const previewContainer = this.nextElementSibling;
      
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          preview.src = e.target.result;
          previewContainer.classList.remove('d-none');
        }
        
        reader.readAsDataURL(this.files[0]);
      }
    });
  });

  // Copy button functionality
  document.querySelectorAll('.copy-btn').forEach(button => {
    button.addEventListener('click', function() {
      const input = this.closest('.input-group').querySelector('input');
      input.select();
      document.execCommand('copy');
      
      // Show feedback
      const originalText = this.innerHTML;
      this.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
      setTimeout(() => {
        this.innerHTML = originalText;
      }, 2000);
    });
  });

  // Form submission handling
  document.querySelectorAll('form[id^="applyForm_"]').forEach(form => {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const submitBtn = this.querySelector('.submit-btn');
      const courseTitle = form.id.replace('applyForm_', '');
      
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Processing...';
      
      try {
        const formData = new FormData(this);
        const response = await fetch('/courses/apply', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('Submission failed');
        }
        
        // Show thank you message
        form.classList.add('d-none');
        const thankYou = document.getElementById(`thankYou_${courseTitle}`);
        if (thankYou) {
          thankYou.classList.remove('d-none');
          thankYou.focus(); // Move focus for accessibility
        }
      } catch (err) {
        alert('Failed to submit application: ' + err.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i> Submit Application';
      }
    });
  });
});
</script>