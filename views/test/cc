<section id="courses" class="py-5">
  <div class="container">
    <h2 class="section-title text-center mb-4">Training Courses</h2>
    <% if (courses && courses.length > 0) { %>
      <div class="row">
        <% courses.forEach(course => { %>
          <div class="col-md-4 mb-4">
            <div class="card h-100">
              <img src="/Uploads/<%= course.photo || 'default.jpg' %>" alt="<%= course.title %>" class="card-img-top" style="height: 200px; object-fit: cover;">
              <div class="card-body">
                <h5 class="card-title"><%= course.title %></h5>
                <p class="card-text"><%= course.description || 'Start your journey with our practical and professional training.' %></p>
                <% if (user && user.enrolledCourses && user.enrolledCourses.includes(course.title)) { %>
                  <a href="/courses/dashboard/<%= course.title %>" class="btn btn-success">Access</a>
                <% } else { %>
                  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#applyModal_<%= course.title.replace(/\s+/g, '_') %>">Apply Now</button>
                <% } %>
              </div>
            </div>
          </div>

          <!-- Course Modal -->
          <div class="modal fade" id="applyModal_<%= course.title.replace(/\s+/g, '_') %>" tabindex="-1" aria-labelledby="applyModalLabel_<%= course.title.replace(/\s+/g, '_') %>" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <form action="/courses/apply" method="POST" enctype="multipart/form-data">
                  <input type="hidden" name="courseKey" value="<%= course.title %>">
                  <input type="hidden" name="userId" value="<%= user ? user.id : '' %>">
                  <div class="modal-header">
                    <h5 class="modal-title" id="applyModalLabel_<%= course.title.replace(/\s+/g, '_') %>">Apply for <%= course.title %></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <p>Welcome to <strong><%= course.title %></strong> training!</p>
                    <ul class="list-group list-group-flush mb-3">
                      <li class="list-group-item">Learn from professional instructors</li>
                      <li class="list-group-item">Get lifetime access to course content</li>
                      <li class="list-group-item">Receive certification upon completion</li>
                    </ul>
                    <div class="mt-3">
                      <p class="fw-bold">Confirm your application to view payment options:</p>
                      <button type="button" class="btn btn-outline-primary mb-3" onclick="togglePayment('<%= course.title.replace(/\s+/g, ',') %>')">Confirm & Show Payment</button>
                    </div>
                    <div id="paymentSection_<%= course.title.replace(/\s+/g, '_') %>" style="display: none;">
                      <p class="fw-bold">Step 1: Payment Instructions</p>
                      <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item"><strong>Telebirr</strong>: Send 6000 ETB to <code>0962935163</code></li>
                        <li class="list-group-item"><strong>CBE Birr</strong>: Send 6000 ETB to the same number</li>
                      </ul>
                      <p class="text-primary mt-2">After sending the payment, upload your screenshot below.</p>
                      <div class="mb-3">
                        <label for="screenshot_<%= course.title.replace(/\s+/g, '_') %>" class="form-label">Upload Screenshot</label>
                        <input type="file" class="form-control" name="screenshot" id="screenshot_<%= course.title.replace(/\s+/g, '_') %>" required>
                      </div>
                      <p class="text-danger small mt-3">Please keep your payment proof. If you don't receive access within 24 hours, contact Dreammore support.</p>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Submit</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <p class="text-center text-muted">No courses available at the moment.</p>
    <% } %>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function togglePayment(courseKey) {
    const paymentSection = document.getElementById(`paymentSection_${courseKey}`);
    if (paymentSection) paymentSection.style.display = 'block';
  }
</script>